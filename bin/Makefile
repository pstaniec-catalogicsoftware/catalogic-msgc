# Makefile to build binaries from the autogenerated files in MSGC

MSGCSRC = ..
VPATH = $(MSGCSRC)

# compilers and precompilers
SED = sed
CPPCOMPILER = g++

# compiler options 
DEFINES   = -DYYDEBUG -DSYNC_NO_MEMBER_TEMPLATE_FRIENDS -DYYERROR_VERBOSE -DYYINITSTACKSIZE=2000 -DYYSTACKSIZE=2000
INCLUDES = -I$(MSGCSRC) -I $(MSGCSRC)/flex-2.6.4/src
CFLAGS    = -ggdb $(DEFINES) $(INCLUDES) -MD -fpermissive -c
CPPCOMPILE = $(CPPCOMPILER) $(CFLAGS)
BUILD     = $(CPPCOMPILER)

.cpp.o:
	$(CPPCOMPILE) $< -o $@

.cpp.d:
	$(CPPCOMPILE) $< -o $@

OBJECTS = msgc.yy.o msgc.tab.o msgc.o

.PHONY: all clean

all: msgc

ifneq ($(MAKECMDGOALS),clean)
include $(OBJECTS:.o=.d)
endif

#bin
msgc : $(OBJECTS) cmdline.o
	$(BUILD) -o $@ $(OBJECTS) cmdline.o

#objects
msgc.yy.o msgc.yy.d : msgc.yy.cpp
	$(CPPCOMPILE) $< -o msgc.yy.o

msgc.tab.o msgc.tab.d : msgc.tab.cpp
	$(CPPCOMPILE) $< -o msgc.tab.o

msgc.o msgc.d : msgc.cpp
	$(CPPCOMPILE) $< -o msgc.o

clean : FORCE
	rm -f msgc $(OBJECTS) $(OBJECTS:.o=.d) cmdline.o cmdline.d cmdline.dd cmdline.P y.tab.h y.output

FORCE :

cmdline.o: cmdline.cpp
	$(CPPCOMPILER) -MD -E -I$(MSGCSRC) $< > cmdline.e.cpp
	mv cmdline.d cmdline.dd
	$(SED) -e 's:cmdline.cpp:cmdline.cpp:g' -e 's/\(cmdline\)\.o[ :]*/\1.o cmdline.d : /g' cmdline.dd > cmdline.d
	cp -p cmdline.d cmdline.P
	$(SED) -e 's/#.*//' -e 's/^[^:]*: *//' -e 's/ *\\$$//' -e '/^$$/ d' -e 's/$$/ :/' < cmdline.d >> cmdline.P
	$(CPPCOMPILER) -c cmdline.e.cpp -static-libgcc -Wall -Wno-deprecated -Wno-missing-braces -O  -pthread -o cmdline.o
	rm -f cmdline.d cmdline.dd cmdline.e.cpp

